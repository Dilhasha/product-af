# !/bin/bash

set -e
MY_PATH="`dirname \"$0\"`"
MY_PATH="`( cd \"$MY_PATH\" && pwd )`"
NAME=jenkins
cd ${MY_PATH}
mkdir -p <%= @jenkins_home %>
export JENKINS_HOME=<%= @jenkins_home %>
mkdir -p <%= @jenkins_log_file_location %>
PIDFILE=<%= @jenkins_home %>/${NAME}.pid

JAVA_CMD="java -jar "
OPTIONAL_JAVA_OPTS=""
DEFAULT_JAVA_OPTS=" -Djavax.net.ssl.trustStore=<%= @clientTrustStore_location %>
                    -Djavax.net.ssl.trustStorePassword=<%= @clientrustStore_password %> "
DEFAULT_JENKINS_OPTS=" --httpPort=-1 --httpsPort=9500
                    --httpsKeyStore=<%= @jenkins_keystore_name %>
                    --httpsKeyStorePassword=<%= @jenkins_keystore_password %> "
LOGS_OPTS=" > /mnt/10.100.5.95/jenkins/logs/jenkins.log 2>&1 & echo \$! > ${PIDFILE}"

if [ -e "${PIDFILE}" ]; then
  PID=`cat ${PIDFILE}`
fi

for c in $*
do
    if [ "$c" = "--debug" ] || [ "$c" = "-debug" ] || [ "$c" = "debug" ]; then
          CMD="--debug"
          continue
    elif [ "$CMD" = "--debug" ]; then
          if [ -z "$PORT" ]; then
                PORT=${c}
          fi
    elif [ "$c" = "--stop" ] || [ "$c" = "-stop" ] || [ "$c" = "stop" ]; then
          CMD="stop"
    elif [ "$c" = "--start" ] || [ "$c" = "-start" ] || [ "$c" = "start" ]; then
          CMD="start"
    fi
done


if [ "$CMD" = "--debug" ]; then
  if [ "$PORT" = "" ]; then
    echo " Please specify the debug port after the --debug option"
    exit 1
  fi
  JAVA_CMD="java -jar "
  OPTIONAL_JAVA_OPTS=" -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=$PORT "
  LOGS_OPTS=""
  echo "Please start the remote debugging client to continue..."
elif [ "$CMD" = "start" ]; then
  if [ -e "${PIDFILE}" ] && [ ! -z "$PID" ]; then
echo "INSIDE "    
if  ps -p ${PID}  > /dev/null ; then
      echo "Process is already running"
      exit 0
    fi
  fi
  JAVA_CMD="nohup java -jar "
elif [ "$CMD" = "stop" ]; then
  if [ ! -z "$PID" ]; then
    if  ps -p ${PID}  > /dev/null ; then
      kill -term ${PID}
      exit 0
    fi
  fi
  echo "No process found"
  exit 0
else
  JAVA_CMD="java -jar "
  LOGS_OPTS=""
fi

echo "Jenkins home "${JENKINS_HOME}
echo "Running jenkins.war..."
RUN_JENKINS_CMD=${JAVA_CMD}" "${DEFAULT_JAVA_OPTS}" "${OPTIONAL_JAVA_OPTS}" ${NAME}.war  "${DEFAULT_JENKINS_OPTS}" "${LOGS_OPTS}
eval ${RUN_JENKINS_CMD}

